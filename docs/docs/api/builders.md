# Builders

## Builder File Configuration

Builders inform TableVault how to build a DataFrame upon instance execution. Builder files are YAML specifications that define how a table instance is constructed or modified.

TableVault supports two built-in builder types:

1.  **`IndexBuilder`**: Produces a new DataFrame, often by defining its primary key and core rows.
2.  **`ColumnBuilder`**: Generates or mutates individual columns within the DataFrame established by the `IndexBuilder`.

Each table instance that is executed must contain exactly one `IndexBuilder`. Additional `ColumnBuilder` files can be included to perform subsequent modifications.

See [Examples](https://www.google.com/search?q=) and [Typical Workflow](https://www.google.com/search?q=) for detailed descriptions of how to use builders.

-----

### IndexBuilder

An `IndexBuilder` is used to produce the initial DataFrame for a table instance. It typically defines the primary structure, index, and the total set of rows, often involving operations like joins or initial data loading.

**Important:** Each executed table instance must include exactly one `IndexBuilder` file, and this file **must be named** according to the pattern: `{table_name}_index.yaml`.

```yaml
builder_type: IndexBuilder

changed_columns: ['COLUMN_NAMES']        # Output columns
python_function: FUNCTION_NAME           # Function to execute
code_module: MODULE_NAME                 # Module containing the function

arguments:                               # Arguments passed to the function
    ARGUMENT_NAME_1: ARG_VALUE
    ARGUMENT_NAME_2: <<TABLE.COLUMN>>    # Reference to another table's column
    ARGUMENT_NAME_3: ~ARTIFACT_FOLDER~   # Special keyword for artifact folder path
n_threads: 1                             # Number of parallel workers (default 1)

# Optional flags
is_custom: false                         # True if using a user-supplied function in code_module
return_type: dataframe                   # return type as one of [row-wise, dataframe, generator]
primary_key: ['COLUMN_NAMES']            # DataFrame primary key
keep_old: false                          # Keep original rows

# Optional column dtypes
dtypes:
    COLUMN_NAME_1: Int64
    COLUMN_NAME_2: Float64
    COLUMN_NAME_3: artifact_string     # Special type for artifact paths

# Optional explicit table dependencies
dependencies: ['TABLE_NAME.COLUMNS']     # e.g., ['Orders.customer_id']
```

-----

### ColumnBuilder

A `ColumnBuilder` is used to add new columns or modify existing ones based on calculations or transformations. It operates on the DataFrame produced by the `IndexBuilder` (or a preceding `ColumnBuilder`).

**Important:** Every `ColumnBuilder` must output a DataFrame that has the exact same number of rows as the DataFrame generated by the `IndexBuilder`. The columns it creates or overwrites must correspond to those listed in its `changed_columns` field.

```yaml
builder_type: ColumnBuilder

changed_columns: ['COLUMN_NAMES']        # Output columns created / overwritten

python_function: FUNCTION_NAME         # e.g., build_features
code_module: MODULE_NAME               # e.g., my_feature_lib

arguments:
    ARGUMENT_NAME_1: ARG_VALUE           # Scalars, lists, environment variables, etc.
    ARGUMENT_NAME_2: <<TABLE.COLUMN>>    # Table reference syntax
    ARGUMENT_NAME_3: ~ARTIFACT_FOLDER~   # Special keyword for artifact folder path
n_threads: 1                           # Parallel workers (default 1)

# Optional flags
is_custom: false                       # Mark as user-supplied (searches in code_functions)
return_type: dataframe                 # return type as one of [row-wise, dataframe, generator]

# Optional column dtypes
dtypes:
    COLUMN_NAME_1: Int64
    COLUMN_NAME_2: Float64
    COLUMN_NAME_3: artifact_string     # Special type for artifact paths

# Optional explicit table dependencies
dependencies: ['TABLE_NAME.COLUMNS']     # e.g., ['Products.price']
```

-----

### Field Reference

| Field             | Type           | Applicability       | Description                                                                                                                                                                                |
| ----------------- | -------------- | ------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| `builder_type`    | `string`       | All                 | Specifies the type of builder. Must be exactly `"IndexBuilder"` or `"ColumnBuilder"`.                                                                                                      |
| `changed_columns` | `list[string]` | All                 | A list of column names that are introduced or modified by this builder.                                                                                                                    |
| `python_function` | `string`       | All                 | The fully qualified name of the Python function to execute (e.g., `my_module.my_function`). The function must be able to accept the declared `arguments`.                                  |
| `code_module`     | `string`       | All                 | The name of the Python module file (e.g., `my_processing_lib.py`) containing the function. Must have been added to the TableVault via the API.                                             |
| `arguments`       | `dict`         | All                 | A key-value mapping passed to the `python_function`. Values can be scalars, lists, table references (`<<TABLE.COLUMN>>`), or the special keyword `~ARTIFACT_FOLDER~`.                      |
| `n_threads`       | `int`          | All                 | The number of parallel worker threads to use for processing. **Default:** `1`.                                                                                                             |
| `is_custom`       | `bool`         | All                 | Indicates the function's source. If `true`, the function is loaded from a user-supplied `code_module`. If `false`, it's loaded from TableVaultâ€™s built-in functions. **Default:** `false`. |
| `return_type`     | `string`       | All                 | Expected return format from `python_function`. Must be one of **`row-wise`**, **`dataframe`**, or **`generator`**. **Default:** `dataframe`.                                               |
| `keep_old`        | `bool`         | `IndexBuilder` only | Determines how rows from a previous instance are handled. If `true`, existing rows not generated by the current run are kept. **Default:** `false`.                                        |
| `primary_key`     | `list[string]` | `IndexBuilder` only | **(Optional)** A list of column names that form a unique row identifier. If omitted, the row position is used.                                                                             |
| `dtypes`          | `dict`         | All                 | **(Optional)** A mapping from column names to pandas data types (e.g., `{"col1": "Int64"}`). Used for type coercion and for declaring `artifact_string` columns.                           |
| `dependencies`    | `list[string]` | All                 | **(Optional)** Overrides automatic dependency detection. A list of explicit table dependencies (e.g., `['Orders.*']`). Required if dependencies are not clear from `arguments`.            |

-----

## Special Keywords

TableVault builders support special keywords that are dynamically replaced with context-aware values at runtime. These keywords enable access to file paths and data from other tables, making configurations more powerful and flexible.

| Keyword | Syntax | Scope | Description |
| :--- | :--- | :--- | :--- |
| **Artifact Folder** | `~ARTIFACT_FOLDER~` | `arguments` | A placeholder that resolves to the absolute path of the artifact folder for the current instance run. It is essential for any function that needs to save or load artifact files. |
| **Table Reference** | `<<...>>` | Most string fields | A dynamic reference used to fetch data from other tables or the current table instance (`self`). The expression within the `<<...>>` is resolved and its value is substituted into the field. |

**Example Usage in `arguments`:**

```yaml
arguments:
  # The ~ARTIFACT_FOLDER~ keyword provides the path for saving a generated file
  artifact_output_path: ~ARTIFACT_FOLDER~

  # The <<...>> syntax fetches a specific configuration value from another table
  source_data_id: "<<config_table.source_id[region::'US']>>"
```

## Function Return Types

- Explain function return types. You have to create your function to match the return signature. generator always yields a tuple with the physical row index and the row-wise column entries. row-wise always returns a tuple (or singular value) representing one row. dataframe always returns a pandas dataframe that contains all saved rows and all columns in `changed_columns`.

---

## Examples

**An `IndexBuilder` that converts a `list` to a `DataFrame`**

=== "Python Code"

    ```python
    create_data_table_from_list(vals: list) -> pandas.DataFrame:
        return pd.DataFrame({"row_index": vals})
    ```

=== "Example YAML Builder"

    ```yaml
    builder_type: IndexBuilder
    changed_columns: [row_index] # only single column
    primary_key: [row_index]
    python_function: create_data_table_from_list
    code_module: table_generation
    arguments:    
        vals: [2, 4, 6, 8]
    is_custom: false
    ```

---


**A `ColumnBuilder` that saves an `fruit_image` file for each `fruit` key**


=== "Python Code"

    ```python
    import shutil

    def fetch_image_from_string(fruit: str, artifact_dir:str ):
        file_path = f'./all_images/{fruit}.png' # pre-existing file
        new_file_path = f'{artifact_dir}/{fruit}.png'
        
        shutil.copy(file_path, new_file_path)
        
        return f'{fruit}.png' # return relative path
    ```

=== "Example YAML Builder"
    ```yaml
    builder_type: ColumnBuilder

    changed_columns: ['fruit_image']                        # Output columns

    python_function: create_data_table_from_table           # Function to execute
    code_module: table_generation                           # Module containing the function
    
    is_custom: true                                         # Mark as user-supplied (searches in code_functions)
    return_type: row-wise                                       # Specifies if the function processes row by row
    
    arguments:                                              # Arguments passed to the function
        fruit: <<self.fruits[index]>> 
        artifact_dir: ~ARTIFACT_FOLDER~ 

    dtypes:                                                 # Column Data Types 
        fruit_image: artifact_string            
    ```

---

**An `IndexBuilder` that yields a batch of `GritLM` embedding to a new row**

---
